# Development Standards for Mediation Ecosystem

**Last Updated**: December 3, 2025
**Applies To**: medfit, probmed, RMediation, medrobust, mediationverse

---

## Table of Contents

1. [R Package Standards](#r-package-standards)
2. [Code Style and Conventions](#code-style-and-conventions)
3. [Object-Oriented Design (S7)](#object-oriented-design-s7)
4. [Documentation Standards](#documentation-standards)
5. [Testing Standards](#testing-standards)
6. [Git and Version Control](#git-and-version-control)
7. [CI/CD Pipeline](#cicd-pipeline)
8. [Website Development (pkgdown)](#website-development-pkgdown)
9. [Vignettes and Articles](#vignettes-and-articles)
10. [Performance and Optimization](#performance-and-optimization)
11. [Security and Privacy](#security-and-privacy)
12. [Accessibility](#accessibility)
13. [CRAN Compliance](#cran-compliance)
14. [Communication and Collaboration](#communication-and-collaboration)

---

## R Package Standards

### Minimum R Version

**Requirement**: R >= 4.1.0

**Rationale**:
- Native pipe `|>` support (R 4.1.0+)
- Improved error messages and debugging
- Better performance for list operations
- Lambda syntax `\(x)` for anonymous functions

```r
# DESCRIPTION
Depends: R (>= 4.1.0)
```

### Package Development Tools

**Required Tools**:

```r
# Install development dependencies
install.packages(c(
  "devtools",      # Development workflow
  "usethis",       # Package setup utilities
  "testthat",      # Testing framework (>= 3.0.0)
  "roxygen2",      # Documentation (>= 7.3.0)
  "pkgdown",       # Website generation
  "rcmdcheck",     # R CMD check wrapper
  "covr",          # Code coverage
  "lintr"          # Code linting
))
```

**Workflow Commands**:

```r
# Daily development
devtools::load_all()           # Load package for testing
devtools::document()           # Generate documentation
devtools::test()               # Run tests
devtools::check()              # R CMD check

# Before release
rcmdcheck::rcmdcheck(args = "--as-cran")
covr::package_coverage()
pkgdown::build_site()
```

### Package Structure

**Standard Directory Layout**:

```
package-name/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ R-CMD-check.yaml      # Multi-platform testing
â”‚       â”œâ”€â”€ test-coverage.yaml    # Coverage reporting
â”‚       â”œâ”€â”€ pkgdown.yaml          # Website deployment
â”‚       â””â”€â”€ lint.yaml             # Code style checking
â”œâ”€â”€ .lintr                        # Linter configuration
â”œâ”€â”€ DESCRIPTION                   # Package metadata
â”œâ”€â”€ NAMESPACE                     # Generated by roxygen2
â”œâ”€â”€ NEWS.md                       # Change log
â”œâ”€â”€ README.md                     # Package overview
â”œâ”€â”€ LICENSE                       # GPL-3 or MIT
â”œâ”€â”€ _pkgdown.yml                  # Website configuration
â”œâ”€â”€ man/                          # Generated documentation
â”œâ”€â”€ R/
â”‚   â”œâ”€â”€ aaa-imports.R            # Package imports
â”‚   â”œâ”€â”€ aab-generics.R           # S7 generics (load before methods)
â”‚   â”œâ”€â”€ package-name-package.R   # Package documentation
â”‚   â”œâ”€â”€ classes.R                # S7 class definitions
â”‚   â”œâ”€â”€ methods-*.R              # S7 method implementations
â”‚   â”œâ”€â”€ utils.R                  # Utility functions
â”‚   â””â”€â”€ zzz.R                    # .onLoad() and .onAttach()
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ testthat.R               # Test runner
â”‚   â””â”€â”€ testthat/
â”‚       â”œâ”€â”€ helper-*.R           # Test helpers and fixtures
â”‚       â”œâ”€â”€ setup.R              # Test setup
â”‚       â””â”€â”€ test-*.R             # Test files
â”œâ”€â”€ vignettes/                   # Quarto vignettes (.qmd)
â””â”€â”€ pkgdown/
    â””â”€â”€ extra.css                # Custom website styling
```

### DESCRIPTION File Standards

**Required Fields**:

```
Package: packagename
Type: Package
Title: Short Description (Title Case, No Period)
Version: 0.0.0.9000
Date: 2025-12-03
Authors@R: c(
    person("First", "Last",
           email = "email@example.com",
           role = c("aut", "cre"),
           comment = c(ORCID = "0000-0000-0000-0000"))
)
Maintainer: First Last <email@example.com>
Description: One paragraph describing what the package does. Must be
    more than one line. Use proper punctuation. Can reference other
    packages in single quotes: 'medfit' provides infrastructure for
    mediation analysis.
License: GPL (>= 3)
URL: https://github.com/data-wise/packagename,
    https://data-wise.github.io/packagename/
BugReports: https://github.com/data-wise/packagename/issues
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.3
Depends:
    R (>= 4.1.0)
Imports:
    S7,
    checkmate,
    rlang
Suggests:
    testthat (>= 3.0.0),
    knitr,
    rmarkdown,
    covr
VignetteBuilder: knitr
Config/testthat/edition: 3
Config/Needs/website: ggplot2, dplyr
```

**Version Numbering**:

- Development: `0.0.0.9000`, `0.1.0.9000`, `0.1.0.9001`
- Release: `0.1.0`, `0.2.0`, `1.0.0`
- Hotfix: `0.1.1`, `1.0.1`

**Semantic Versioning**:

- **MAJOR** (1.0.0): Breaking changes, incompatible API
- **MINOR** (0.1.0): New features, backward compatible
- **PATCH** (0.0.1): Bug fixes, no new features

---

## Code Style and Conventions

### Style Guide

**Base Standard**: [Tidyverse Style Guide](https://style.tidyverse.org/)

**Key Principles**:
- Readability over cleverness
- Consistency across codebase
- Self-documenting code with strategic comments
- Explicit over implicit

### Naming Conventions

#### Functions

**Use snake_case**:

```r
# CORRECT
fit_mediation <- function(...) {}
extract_mediation <- function(...) {}
bootstrap_mediation <- function(...) {}

# INCORRECT
fitMediation <- function(...) {}
Fit.Mediation <- function(...) {}
FitMediation <- function(...) {}
```

**Internal Functions (prefix with dot)**:

```r
# Internal implementation
.fit_mediation_glm <- function(...) {}
.bootstrap_parametric <- function(...) {}
.validate_inputs <- function(...) {}
```

**Verb-Based Names**:

```r
# Good - describes action
compute_pmed()
extract_paths()
validate_model()

# Bad - unclear action
pmed()
paths()
model()
```

#### Arguments

**Use snake_case**:

```r
# Function signature
my_function <- function(
  formula_y,        # Model formulas
  formula_m,
  treatment,        # Variable names
  mediator,
  outcome,
  data,            # Data objects
  n_boot = 5000,   # Numeric parameters
  ci_level = 0.95,
  method = "parametric",  # Options
  engine = "glm",
  verbose = FALSE  # Flags
) {
  # ...
}
```

**Standard Argument Names Across Ecosystem**:

| Concept | Standard Name | Type | Example |
|---------|---------------|------|---------|
| Mediation data | `object` | MediationData | First arg to methods |
| Mediator model | `formula_m` or `model_m` | formula or model | `M ~ X + C` |
| Outcome model | `formula_y` or `model_y` | formula or model | `Y ~ X + M + C` |
| Treatment variable | `treatment` | character | `"X"` |
| Mediator variable | `mediator` | character or vector | `"M"` or `c("M1", "M2")` |
| Outcome variable | `outcome` | character | `"Y"` |
| Data frame | `data` | data.frame | `mydata` |
| Bootstrap samples | `n_boot` | integer | `5000` |
| Confidence level | `ci_level` | numeric | `0.95` |
| Method type | `method` | character | `"parametric"` |
| Modeling engine | `engine` | character | `"glm"` |
| Verbose output | `verbose` | logical | `TRUE` or `FALSE` |

#### S7 Classes

**Use CamelCase**:

```r
# CORRECT
MediationData <- S7::new_class("MediationData", ...)
SerialMediationData <- S7::new_class("SerialMediationData", ...)
BootstrapResult <- S7::new_class("BootstrapResult", ...)

# INCORRECT
mediation_data <- S7::new_class("mediation_data", ...)
Mediation_Data <- S7::new_class("Mediation_Data", ...)
```

#### S7 Properties

**Use snake_case**:

```r
MediationData <- S7::new_class(
  "MediationData",
  properties = list(
    a_path = S7::class_numeric,      # Path coefficients
    b_path = S7::class_numeric,
    c_prime = S7::class_numeric,
    estimates = S7::class_numeric,   # Full estimates
    vcov = S7::class_matrix,         # Covariance matrix
    treatment = S7::class_character,  # Variable names
    mediator = S7::class_character,
    outcome = S7::class_character
  )
)
```

#### Variables

**Use snake_case**:

```r
# Good
boot_estimates <- replicate(n_boot, ...)
indirect_effect <- a_path * b_path
conf_interval <- quantile(boot_estimates, c(0.025, 0.975))

# Bad
bootEstimates <- replicate(n_boot, ...)
IE <- a_path * b_path
CI <- quantile(bootEstimates, c(0.025, 0.975))
```

### Code Formatting

#### Line Length

**Maximum**: 80 characters (prefer 80, allow up to 100 for readability)

```r
# Good - under 80 characters
result <- bootstrap_mediation(med_data, statistic = compute_pmed,
                               n_boot = 5000, ci_level = 0.95)

# Acceptable - under 100, improves readability
my_very_descriptive_variable_name <- some_function_with_long_name(
  argument_one = value_one,
  argument_two = value_two
)

# Bad - over 100 characters
result <- bootstrap_mediation(med_data, statistic = compute_pmed, n_boot = 5000, ci_level = 0.95, method = "parametric", parallel = TRUE)
```

#### Indentation

**Use 2 spaces** (never tabs):

```r
# CORRECT
my_function <- function(x, y) {
  if (x > 0) {
    result <- x + y
    return(result)
  } else {
    return(0)
  }
}

# INCORRECT (4 spaces or tabs)
my_function <- function(x, y) {
    if (x > 0) {
        result <- x + y
        return(result)
    }
}
```

#### Assignment

**Use `<-` for assignment, NOT `=`**:

```r
# CORRECT
x <- 10
my_data <- data.frame(a = 1:5, b = 6:10)

# INCORRECT
x = 10
my_data = data.frame(a = 1:5, b = 6:10)
```

**Exception**: Use `=` for function arguments:

```r
# CORRECT
result <- my_function(arg1 = value1, arg2 = value2)

# INCORRECT
result <- my_function(arg1 <- value1, arg2 <- value2)
```

#### Spacing

**Infix Operators**:

```r
# CORRECT
x <- 10
y <- x + 5
z <- a * b / c

# INCORRECT
x<-10
y<- x+5
z <- a*b/c
```

**Function Calls**:

```r
# CORRECT
my_function(arg1, arg2, arg3)
list(a = 1, b = 2)

# INCORRECT
my_function (arg1, arg2, arg3)  # Extra space before (
list(a=1, b=2)                   # No space around =
```

**Commas**:

```r
# CORRECT
c(1, 2, 3, 4)
data.frame(x = 1:5, y = 6:10)

# INCORRECT
c(1,2,3,4)
data.frame(x = 1:5,y = 6:10)
```

### Pipe Operator

**Use native pipe `|>`** (R >= 4.1.0):

```r
# CORRECT (native pipe)
result <- data |>
  filter(x > 0) |>
  mutate(y = x * 2) |>
  summarize(mean_y = mean(y))

# AVOID (magrittr pipe, unless needed for special features)
result <- data %>%
  filter(x > 0) %>%
  mutate(y = x * 2) %>%
  summarize(mean_y = mean(y))
```

**Pipe Formatting**:

```r
# Good - each step on new line
result <- data |>
  step_one() |>
  step_two(arg = value) |>
  step_three()

# Acceptable - short pipeline on one line
result <- data |> filter(x > 0) |> select(a, b)

# Bad - inconsistent indentation
result <- data |>
step_one() |>
  step_two()
```

### Comments

#### Comment Style

**Use `#` for all comments**:

```r
# This is a comment
# This is a multi-line comment
# that spans several lines
```

**Section Headers** (for long files):

```r
# --- Section Name ---

# Or for major sections:
# =============================================================================
# Major Section Name
# =============================================================================
```

#### When to Comment

**DO comment**:
- **Why**, not **what** (explain reasoning, not obvious operations)
- Tricky or non-obvious code
- Statistical formulas and methods
- References to papers or documentation
- Workarounds for bugs
- Performance optimizations

```r
# GOOD - explains WHY
# Use outer product for efficient pairwise computation (O(nÂ²) memory but O(1) loops)
pairwise_diff <- outer(x, x, `-`)

# Adjust for 1-based indexing expected by lavaan
x <- x + 1

# Per VanderWeele (2014), four-way decomposition requires: TE = CDE + INTref + INTmed + PIE
components <- compute_four_way_decomposition(a, b, c_prime, interaction)

# BAD - explains WHAT (obvious from code)
# Add 1 to x
x <- x + 1

# Loop through data
for (i in seq_along(data)) {
  # ...
}
```

**DON'T comment**:
- Obvious operations
- Auto-generated comments (like "Function to compute X" when function is named `compute_x()`)
- Commented-out code (delete it - use git history if needed)

#### TODO Comments

**Standard Format**:

```r
# TODO: Add support for multiple mediators (issue #42)
# FIXME: Breaks when n < 10, needs better error handling
# HACK: Workaround for lavaan bug, remove when fixed upstream
# NOTE: Assumes Gaussian residuals for variance computation
# OPTIMIZE: Could vectorize this loop for 10x speedup
```

---

## Object-Oriented Design (S7)

### When to Use S7

**Use S7 for**:
- Core data structures shared across packages
- Type-safe interfaces
- Method dispatch on object type
- Complex validation logic

**Don't use S7 for**:
- Simple functions with no state
- One-off data structures
- Internal implementation details

### S7 Class Design

#### Class Definition Template

```r
MyClass <- S7::new_class(
  name = "MyClass",
  package = "packagename",  # REQUIRED - prevents namespace conflicts
  properties = list(
    # Scalar properties
    a_path = S7::class_numeric,
    name = S7::class_character,

    # Vector properties (use class_* for built-in types)
    estimates = S7::class_numeric,
    labels = S7::class_character,

    # Matrix properties
    vcov = S7::class_matrix,

    # Data frame properties
    data = S7::new_union(S7::class_data.frame, S7::class_NULL),

    # S3 class properties
    model = S7::new_S3_class("lm"),

    # Optional properties (use union with NULL)
    optional_value = S7::new_union(S7::class_numeric, S7::class_NULL),

    # Custom S7 class properties
    nested_object = MyOtherClass
  ),
  validator = function(self) {
    # Validation logic (return character string for error, NULL for valid)

    # Check lengths match
    if (length(self@estimates) != nrow(self@vcov)) {
      return("Length of estimates must match dimensions of vcov")
    }

    # Check positive values
    if (any(self@a_path < 0)) {
      return("a_path must be non-negative")
    }

    # Check data consistency
    if (!is.null(self@data) && nrow(self@data) != self@n) {
      return("Data rows must match n")
    }

    # Return NULL if all validations pass
    NULL
  }
)
```

#### Property Type Standards

**Use built-in class_* for standard types**:

```r
# Correct - use S7 built-in class wrappers
properties = list(
  x = S7::class_numeric,
  name = S7::class_character,
  flag = S7::class_logical,
  data = S7::class_data.frame,
  mat = S7::class_matrix,
  lst = S7::class_list
)

# Incorrect - manual class specification
properties = list(
  x = class_numeric,          # Missing S7:: namespace
  name = "character",         # String, not class object
  flag = logical              # Base R class, not S7 class
)
```

**Optional Properties (allow NULL)**:

```r
# Use new_union for optional properties
properties = list(
  required_value = S7::class_numeric,
  optional_value = S7::new_union(S7::class_numeric, S7::class_NULL),
  optional_data = S7::new_union(S7::class_data.frame, S7::class_NULL)
)
```

#### Validation Best Practices

**Keep validators simple and focused**:

```r
# Good - clear, single-purpose checks
validator = function(self) {
  if (length(self@a_path) != 1) {
    return("a_path must be scalar")
  }

  if (self@a_path < 0) {
    return("a_path must be non-negative")
  }

  if (length(self@estimates) != nrow(self@vcov)) {
    return("estimates length must match vcov dimensions")
  }

  NULL  # Valid
}

# Bad - complex, hard to debug
validator = function(self) {
  if (length(self@a_path) != 1 || self@a_path < 0 ||
      length(self@estimates) != nrow(self@vcov)) {
    return("Validation failed")  # Which check failed?
  }
  NULL
}
```

**Use informative error messages**:

```r
# Good - specific, actionable
return("vcov must be symmetric positive definite matrix")
return("mediators must be non-empty character vector")
return(sprintf("Expected %d estimates, got %d", expected, actual))

# Bad - vague
return("Invalid input")
return("Check your data")
```

### S7 Method Design

#### Generic Definition

```r
# Define generic in aab-generics.R (loads before methods)
#' Extract Mediation Structure
#'
#' @param object Fitted model object
#' @param ... Additional arguments passed to methods
#' @export
extract_mediation <- S7::new_generic(
  name = "extract_mediation",
  dispatch_args = "object"  # Dispatch on first argument
)
```

#### Method Implementation

```r
# Implement method for specific class
#' @noRd  # Don't generate .Rd file (prevents namespace issues)
S7::method(extract_mediation, S7::new_S3_class("lm")) <- function(object,
                                                                    model_y = NULL,
                                                                    treatment,
                                                                    mediator,
                                                                    ...) {
  # --- Input Validation ---
  checkmate::assert_class(object, "lm")
  checkmate::assert_class(model_y, "lm", null.ok = TRUE)
  checkmate::assert_string(treatment)
  checkmate::assert_string(mediator)

  # --- Extract Parameters ---
  # ... implementation ...

  # --- Return MediationData Object ---
  MediationData(
    a_path = a,
    b_path = b,
    c_prime = c_prime,
    # ... other properties ...
  )
}
```

#### Method Documentation

**Generic: Document shared parameters only**:

```r
#' Extract Mediation Structure
#'
#' @param object Fitted model object
#' @param ... Additional arguments passed to methods. Common arguments:
#'   - `treatment`: Character string specifying treatment variable name
#'   - `mediator`: Character string or vector specifying mediator(s)
#'   - `outcome`: Character string specifying outcome variable name
#'
#' @return A [MediationData] or [SerialMediationData] object
#' @export
extract_mediation <- S7::new_generic(...)
```

**Methods: Use @noRd to prevent .Rd generation**:

```r
#' Extract Mediation from lm/glm Models
#'
#' @param object An lm or glm model for the mediator
#' @param model_y An lm or glm model for the outcome
#' @param treatment Character: treatment variable name
#' @param mediator Character: mediator variable name
#' @param ... Additional arguments (ignored)
#'
#' @noRd  # CRITICAL - prevents namespace export issues
S7::method(extract_mediation, S7::new_S3_class("lm")) <- function(...) {
  # ...
}
```

### S7 Registration (.onLoad)

**CRITICAL**: All S7 classes and methods MUST be registered in `.onLoad()`:

```r
# R/zzz.R
.onLoad <- function(libname, pkgname) {
  # 1. Register S7 classes with S4 system (BEFORE methods_register)
  S7::S4_register(MediationData)
  S7::S4_register(SerialMediationData)
  S7::S4_register(BootstrapResult)

  # 2. Register S7 methods for dispatch
  S7::methods_register()

  # 3. Register methods for Suggested packages (conditional)
  if (requireNamespace("lavaan", quietly = TRUE)) {
    tryCatch({
      .register_lavaan_method()
    }, error = function(e) {
      # Silent fail - method won't be available but package still loads
      invisible(NULL)
    })
  }
}

# Helper for conditional registration
.register_lavaan_method <- function() {
  lavaan_class <- S7::as_class(methods::getClass("lavaan", where = "lavaan"))
  S7::method(extract_mediation, lavaan_class) <- extract_mediation_lavaan
}
```

**Import Requirements**:

```r
# In DESCRIPTION
Imports:
    S7,
    methods  # REQUIRED for S4_register()

# In R/aaa-imports.R
#' @import S7
#' @import methods
NULL
```

---

## Documentation Standards

### roxygen2 Guidelines

#### Function Documentation Template

```r
#' Short Title (One Line, Title Case)
#'
#' @description
#' A paragraph describing what the function does. Should be concise but
#' informative. Can span multiple lines.
#'
#' @param param_name Description of parameter. For complex parameters,
#'   explain expected format, valid values, or structure.
#' @param another_param Another parameter description
#' @param ... Additional arguments passed to methods or other functions
#'
#' @return Description of return value. Include type and structure.
#'   For complex returns, use bulleted list:
#'   \itemize{
#'     \item \code{element1}: Description
#'     \item \code{element2}: Description
#'   }
#'
#' @details
#' ## Extended Details
#'
#' More comprehensive explanation if needed. Can include:
#' - Algorithm details
#' - Statistical background
#' - Usage notes
#' - Performance considerations
#'
#' ## Mathematical Background
#'
#' Equations can be included with \eqn{} and \deqn{}:
#'
#' The indirect effect is \eqn{a \times b}{a * b} where:
#' \itemize{
#'   \item \eqn{a}: Effect of X on M
#'   \item \eqn{b}: Effect of M on Y controlling for X
#' }
#'
#' @examples
#' # Basic usage
#' result <- my_function(x = 10, y = 20)
#'
#' # Advanced usage
#' result <- my_function(
#'   x = 10,
#'   y = 20,
#'   option = "advanced"
#' )
#'
#' \dontrun{
#' # Code that requires external resources
#' result <- my_function_with_api(api_key = "SECRET")
#' }
#'
#' @references
#' Author A, Author B (Year). Title of paper. *Journal Name*, volume(issue),
#' pages. \doi{10.xxxx/xxxxx}
#'
#' @seealso [related_function()], [OtherClass]
#'
#' @export
my_function <- function(param_name, another_param, ...) {
  # Implementation
}
```

#### S7 Class Documentation

```r
#' Short Title for S7 Class
#'
#' @description
#' Description of what the class represents and when to use it.
#'
#' @param property1 Description of property (document ALL properties)
#' @param property2 Description of property
#' @param optional_prop Description of optional property. Defaults to NULL.
#'
#' @return An S7 object of class MyClass
#'
#' @details
#' ## Properties
#'
#' - \code{property1}: Detailed description with type and constraints
#' - \code{property2}: Detailed description
#' - \code{optional_prop}: Optional property (default: NULL)
#'
#' ## Validation
#'
#' The class validator ensures:
#' - property1 is positive
#' - property2 has correct length
#'
#' @examples
#' # Create instance
#' obj <- MyClass(
#'   property1 = 10,
#'   property2 = "value"
#' )
#'
#' # Access properties
#' obj@property1
#'
#' @seealso [related_class()], [generic_method()]
#'
#' @export
MyClass <- S7::new_class(...)
```

### Math Documentation

#### In roxygen2 (Help Files)

**Use `\eqn{}` and `\deqn{}`** for equations:

```r
#' The indirect effect is \eqn{a \times b}{a * b}
#'
#' Sampling distribution:
#' \deqn{N(\hat{\theta}, \hat{\Sigma})}{N(theta-hat, Sigma-hat)}
```

**Syntax**:
- `\eqn{latex}{ascii}` - inline equation (LaTeX + ASCII fallback)
- `\deqn{latex}{ascii}` - display equation (block)
- Single argument form: `\eqn{latex}` uses same for both

**Common LaTeX in roxygen2**:

```r
# Greek letters
\eqn{\alpha}, \eqn{\beta}, \eqn{\theta}, \eqn{\Sigma}

# Hats and accents
\eqn{\hat{x}}, \eqn{\bar{x}}, \eqn{\tilde{x}}

# Subscripts/superscripts
\eqn{x_i}, \eqn{x^2}, \eqn{\theta_{ij}}

# Fractions
\eqn{\frac{a}{b}}{a/b}

# Operators
\eqn{a \times b}{a * b}
\eqn{a \cdot b}{a * b}
\eqn{\sum_{i=1}^{n} x_i}{sum(x_i, i=1..n)}
```

**DON'T use Unicode math characters** in .Rd/roxygen2:

```r
# WRONG - causes LaTeX PDF errors
#' The effect is Î¸Ì‚ with variance Î£

# CORRECT
#' The effect is \eqn{\hat{\theta}} with variance \eqn{\Sigma}
```

#### In Quarto/RMarkdown Vignettes

**Use standard LaTeX with `$` and `$$`**:

```markdown
The indirect effect is $a \times b$ where $a$ is the Xâ†’M path.

The sampling distribution is:
$$\hat{\theta} \sim N(\theta, \Sigma)$$
```

### NEWS.md Format

**Structure**:

```markdown
# packagename (development version)

## New Features

* Added `new_function()` for doing X (#123)
* `existing_function()` now supports Y via new `option` argument

## Bug Fixes

* Fixed crash when input is empty (#456)
* Corrected calculation of Z in edge case

## Breaking Changes

* `old_function()` renamed to `new_function()` for clarity
* Argument `old_arg` removed (use `new_arg` instead)

## Internal

* Improved performance of internal utility
* Updated documentation for clarity

# packagename 0.1.0

## Initial Release

* Initial CRAN submission
* Core functions: `func1()`, `func2()`
* Vignettes: "Introduction", "Advanced Usage"
```

**Guidelines**:
- Use `#` for version headers
- Use `##` for category headers
- Use `*` for bulleted items
- Reference issues/PRs with `(#123)`
- Most recent version at top
- Keep entries concise

---

## Testing Standards

### Test Coverage Requirements

**Minimum Coverage**: 80% overall

**Critical Paths**: 100% coverage required for:
- S7 class constructors and validators
- Public API functions
- Error handling and edge cases

**Check Coverage**:

```r
# Full report
covr::package_coverage()

# HTML report
covr::report()

# Specific file
covr::file_coverage("R/classes.R", "tests/testthat/test-classes.R")
```

### Test Organization

#### File Naming

```
tests/testthat/
â”œâ”€â”€ helper-*.R          # Test helpers (no test_ prefix)
â”œâ”€â”€ setup.R             # Global test setup
â”œâ”€â”€ test-classes.R      # Tests for R/classes.R
â”œâ”€â”€ test-extract-lm.R   # Tests for R/extract-lm.R
â”œâ”€â”€ test-bootstrap.R    # Tests for R/bootstrap.R
â””â”€â”€ test-utils.R        # Tests for R/utils.R
```

**Convention**: `test-*.R` matches `R/*.R`

#### Test Structure

```r
# test-myfunction.R

# Use describe() blocks for organization (optional but recommended)
describe("my_function", {

  # Test group
  describe("input validation", {
    test_that("rejects NULL input", {
      expect_error(my_function(NULL), "must not be NULL")
    })

    test_that("rejects negative values", {
      expect_error(my_function(-1), "must be non-negative")
    })
  })

  describe("core functionality", {
    test_that("computes correct result for simple case", {
      result <- my_function(x = 10)
      expect_equal(result, 20)
    })

    test_that("handles edge case", {
      result <- my_function(x = 0)
      expect_equal(result, 0)
    })
  })

  describe("error handling", {
    test_that("provides informative error for invalid input", {
      expect_error(
        my_function(x = "invalid"),
        "x must be numeric",
        class = "checkmate_error"
      )
    })
  })
})
```

### Test Patterns

#### Testing Functions

```r
test_that("function produces correct output", {
  # Arrange
  input_data <- data.frame(x = 1:10, y = 11:20)
  expected_output <- 55

  # Act
  result <- my_function(input_data)

  # Assert
  expect_equal(result, expected_output)
  expect_type(result, "double")
  expect_length(result, 1)
})
```

#### Testing S7 Classes

```r
test_that("MyClass validator catches invalid input", {
  # Valid construction should work
  obj <- MyClass(a_path = 1, b_path = 2)
  expect_s7_class(obj, MyClass)

  # Invalid construction should fail
  expect_error(
    MyClass(a_path = -1, b_path = 2),
    "a_path must be non-negative"
  )

  expect_error(
    MyClass(a_path = c(1, 2), b_path = 2),
    "a_path must be scalar"
  )
})

test_that("MyClass properties are correct", {
  obj <- MyClass(a_path = 1.5, b_path = 2.5)

  expect_equal(obj@a_path, 1.5)
  expect_equal(obj@b_path, 2.5)
  expect_type(obj@a_path, "double")
})
```

#### Testing Methods

```r
test_that("extract_mediation works for lm objects", {
  # Create test models
  fit_m <- lm(M ~ X, data = test_data)
  fit_y <- lm(Y ~ X + M, data = test_data)

  # Extract
  result <- extract_mediation(
    fit_m,
    model_y = fit_y,
    treatment = "X",
    mediator = "M"
  )

  # Assertions
  expect_s7_class(result, MediationData)
  expect_equal(result@treatment, "X")
  expect_equal(result@mediator, "M")
  expect_true(result@converged)
})
```

#### Testing Error Conditions

```r
test_that("function errors with informative message", {
  expect_error(
    my_function(invalid_input),
    "invalid_input must be numeric",
    fixed = TRUE  # Exact match
  )

  expect_error(
    my_function(invalid_input),
    "must be numeric"  # Partial match (default)
  )

  # Check error class
  expect_error(
    my_function(invalid_input),
    class = "checkmate_error"
  )
})
```

#### Testing with Fixtures

```r
# helper-fixtures.R
make_test_data <- function(n = 100, seed = 42) {
  set.seed(seed)
  data.frame(
    X = rnorm(n),
    M = rnorm(n),
    Y = rnorm(n)
  )
}

# test-myfunction.R
test_that("function works with test data", {
  data <- make_test_data(n = 50)
  result <- my_function(data)
  expect_equal(nrow(result), 50)
})
```

#### Snapshot Testing

For complex outputs (plots, print methods):

```r
test_that("print method output is stable", {
  obj <- MyClass(a_path = 1, b_path = 2)
  expect_snapshot(print(obj))
})

# First run creates snapshot
# Subsequent runs compare to snapshot
# Update with: testthat::snapshot_accept()
```

### Testing Best Practices

1. **Arrange-Act-Assert Pattern**: Structure tests clearly
2. **One Assertion Focus**: Each test should test one thing
3. **Descriptive Test Names**: Explain what's being tested
4. **Use Test Fixtures**: Create reusable test data generators
5. **Test Edge Cases**: Empty inputs, NA, NULL, zero-length vectors
6. **Test Errors**: Ensure errors are informative
7. **Seed for Reproducibility**: Set `set.seed()` for random tests
8. **Skip Conditionally**: Use `skip_if_not_installed()`, `skip_on_cran()`

```r
test_that("function works with optional package", {
  skip_if_not_installed("lavaan")
  # ... test using lavaan ...
})

test_that("slow test", {
  skip_on_cran()  # Skip on CRAN to avoid timeout
  # ... computationally intensive test ...
})
```

---

## Git and Version Control

### Commit Message Format

**Structure**:

```
type(scope): short description

Longer explanation if needed. Explain WHY, not WHAT.
Reference issues, provide context.

Fixes #123
```

**Types**:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation only
- `test`: Adding or updating tests
- `refactor`: Code refactoring (no behavior change)
- `perf`: Performance improvement
- `style`: Code style/formatting (no logic change)
- `chore`: Build process, dependencies, etc.
- `ci`: CI/CD pipeline changes

**Examples**:

```
feat(bootstrap): add parametric bootstrap method

Implements parametric bootstrap by sampling from N(Î¸Ì‚, Î£Ì‚).
Includes parallel processing support via mclapply.

Closes #42

---

fix(lavaan): handle dimension mismatch in vcov extraction

lavaan models with parameter constraints had mismatched
vcov dimensions. Now checks and adjusts correctly.

Fixes #156

---

docs: update API-CONTRACTS.md with bootstrap signature

Added detailed signature and examples for bootstrap_mediation()
across packages.

---

test: add edge cases for empty mediator names

Ensures proper error handling when mediator = "" or NA.

---

refactor(extract): simplify lm parameter extraction

Reduced code duplication by extracting common logic to helper.
No behavior change.
```

### Branch Naming

See `BRANCHING-STRATEGY.md` for full details.

**Summary**:

```
feature/descriptive-name
fix/issue-123-description
refactor/component-name
docs/topic
test/coverage-area
ecosystem/cross-package-feature
release/v0.2.0
hotfix/critical-bug
```

### Pull Request Template

Create `.github/PULL_REQUEST_TEMPLATE.md`:

```markdown
## Description

Brief description of changes.

## Type of Change

- [ ] Bug fix (non-breaking)
- [ ] New feature (non-breaking)
- [ ] Breaking change
- [ ] Documentation update

## Checklist

- [ ] Code follows style guide
- [ ] Self-review completed
- [ ] Comments added for complex code
- [ ] Documentation updated (roxygen2, vignettes, NEWS.md)
- [ ] Tests added/updated (coverage â‰¥80%)
- [ ] All tests pass locally
- [ ] No new warnings in R CMD check
- [ ] `devtools::check()` passes

## Testing

Describe testing performed:
- Unit tests added for ...
- Manual testing with ...
- Edge cases covered: ...

## Related Issues

Fixes #123
Relates to #456
```

---

## CI/CD Pipeline

### Required Workflows

Every package must have these GitHub Actions workflows:

#### 1. R-CMD-check.yaml

**Purpose**: Multi-platform package checking

```yaml
# .github/workflows/R-CMD-check.yaml
name: R-CMD-check

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        r-version: ['release']

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - uses: r-lib/actions/check-r-package@v2
        with:
          args: 'c("--no-manual", "--as-cran")'
          error-on: '"warning"'
```

#### 2. test-coverage.yaml

**Purpose**: Track code coverage

```yaml
# .github/workflows/test-coverage.yaml
name: test-coverage

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::covr, any::xml2
          needs: coverage

      - name: Test coverage
        run: |
          cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = file.path(normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/"), "package")
          )
          covr::to_cobertura(cov)
        shell: Rscript {0}

      - uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: true
          files: ./cobertura.xml
          token: ${{ secrets.CODECOV_TOKEN }}
```

#### 3. pkgdown.yaml

**Purpose**: Build and deploy website

```yaml
# .github/workflows/pkgdown.yaml
name: pkgdown

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  pkgdown:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::pkgdown, local::.
          needs: website

      - name: Build site
        run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}

      - name: Deploy to GitHub pages ðŸš€
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4.5.0
        with:
          clean: false
          branch: gh-pages
          folder: docs
```

#### 4. lint.yaml (Optional but Recommended)

**Purpose**: Enforce code style

```yaml
# .github/workflows/lint.yaml
name: lint

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::lintr, local::.
          needs: lint

      - name: Lint
        run: lintr::lint_package()
        shell: Rscript {0}
        env:
          LINTR_ERROR_ON_LINT: true
```

### lintr Configuration

Create `.lintr` file in package root:

```r
linters: linters_with_defaults(
  line_length_linter(120),
  object_name_linter(styles = c("snake_case", "CamelCase")),
  indentation_linter(indent = 2L),
  trailing_whitespace_linter(),
  commented_code_linter = NULL  # Allow code in comments for examples
)
exclusions: list(
  "R/aaa-imports.R",
  "R/RcppExports.R"
)
```

---

## Website Development (pkgdown)

### _pkgdown.yml Configuration

**Template**:

```yaml
url: https://data-wise.github.io/packagename

template:
  bootstrap: 5
  bslib:
    primary: "#0054AD"
    border-radius: 0.5rem
    btn-border-radius: 0.25rem
  math-rendering: mathjax

navbar:
  structure:
    left:  [intro, reference, articles, tutorials, news]
    right: [search, github]
  components:
    home:
      icon: fas fa-home fa-lg
      href: index.html
    reference:
      text: Reference
      href: reference/index.html
    articles:
      text: Articles
      menu:
      - text: Getting Started
        href: articles/getting-started.html
      - text: Advanced Usage
        href: articles/advanced-usage.html
    github:
      icon: fab fa-github fa-lg
      href: https://github.com/data-wise/packagename/

reference:
  - title: Main Functions
    desc: Core package functionality
    contents:
      - starts_with("fit_")
      - starts_with("extract_")
      - starts_with("bootstrap_")

  - title: S7 Classes
    desc: Data structures
    contents:
      - MediationData
      - SerialMediationData
      - BootstrapResult

  - title: Methods
    desc: S7 methods
    contents:
      - starts_with("print.")
      - starts_with("summary.")

  - title: Utilities
    desc: Helper functions
    contents:
      - has_concept("utilities")

articles:
  - title: Get Started
    navbar: Getting Started
    contents:
      - getting-started

  - title: Advanced
    navbar: Advanced Topics
    contents:
      - advanced-usage
      - serial-mediation
      - bootstrap-methods

footer:
  structure:
    left: developed_by
    right: built_with

authors:
  First Last:
    href: https://example.com
    html: "<img src='https://orcid.org/sites/default/files/images/orcid_16x16.png' alt='ORCID' /> <a href='https://orcid.org/0000-0000-0000-0000'>0000-0000-0000-0000</a>"
```

### Homepage (README.md)

**Structure**:

```markdown
# packagename <img src="man/figures/logo.png" align="right" height="139" alt="" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/data-wise/packagename/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/data-wise/packagename/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/data-wise/packagename/branch/main/graph/badge.svg)](https://app.codecov.io/gh/data-wise/packagename?branch=main)
[![CRAN status](https://www.r-pkg.org/badges/version/packagename)](https://CRAN.R-project.org/package=packagename)
<!-- badges: end -->

One paragraph overview of the package. What problem does it solve?
Who is the target audience?

## Installation

Install from CRAN:

``` r
install.packages("packagename")
```

Or install the development version from GitHub:

``` r
# install.packages("pak")
pak::pak("data-wise/packagename")
```

## Usage

Brief, compelling example:

``` r
library(packagename)

# Simple example
result <- main_function(data, ...)
print(result)
```

## Features

- Feature 1: Description
- Feature 2: Description
- Feature 3: Description

## Getting Help

- [Documentation website](https://data-wise.github.io/packagename/)
- [GitHub issues](https://github.com/data-wise/packagename/issues)
- [Vignettes](https://data-wise.github.io/packagename/articles/)

## Citation

``` r
citation("packagename")
```

## Code of Conduct

Please note that this project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html).
By contributing to this project, you agree to abide by its terms.

## License

GPL (>= 3)
```

### Package Logo

Create logo with `hexSticker`:

```r
# Create logo (one-time)
library(hexSticker)

sticker(
  subplot = ~ plot(1:10),  # Or load image
  package = "packagename",
  p_size = 20,
  s_x = 1,
  s_y = 0.75,
  s_width = 1.3,
  s_height = 1,
  h_fill = "#0054AD",
  h_color = "#003D82",
  filename = "man/figures/logo.png",
  dpi = 300
)

# Add to README
usethis::use_logo("man/figures/logo.png")
```

---

## Vignettes and Articles

### Quarto Vignettes (.qmd)

**Prefer Quarto over R Markdown** for new vignettes:

**Create vignette**:

```r
usethis::use_vignette("vignette-name", title = "Vignette Title")
# Then rename .Rmd to .qmd and update YAML
```

**Quarto YAML Header**:

```yaml
---
title: "Getting Started with packagename"
author: "Your Name"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: false
    df-print: kable
vignette: >
  %\VignetteIndexEntry{Getting Started with packagename}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---
```

**Quarto Code Chunk Syntax** (PREFERRED):

````markdown
```{r}
#| label: chunk-name
#| eval: true
#| echo: true
#| warning: false
#| message: false
#| fig-width: 8
#| fig-height: 6

# Code here
x <- 1 + 1
```
````

**DON'T use R Markdown chunk syntax**:

````markdown
```{r chunk-name, eval=TRUE, echo=TRUE}  # OLD STYLE - avoid
x <- 1 + 1
```
````

### Articles vs Vignettes

**Vignettes**:
- Included in package build
- Run during R CMD check
- Must execute quickly (<5 seconds per vignette)
- Use for: Essential documentation, quick examples

**Articles** (use for heavy computation):

```r
# Create article (not run during check)
usethis::use_article("article-name")
```

- NOT included in package build
- NOT run during R CMD check
- Can be slow, require credentials, use large data
- Use for: Advanced examples, simulations, case studies

**When to use Articles**:
- Computationally expensive examples (>10 seconds)
- Require API keys or authentication
- Download large datasets
- Heavy simulations or bootstrap

### Vignette Best Practices

1. **Start with motivation**: Why does the user need this?
2. **Simple example first**: Show the most common use case
3. **Build complexity gradually**: Simple â†’ intermediate â†’ advanced
4. **Use real or realistic data**: Toy examples are fine for syntax, but show real use
5. **Explain outputs**: Don't just show code, interpret results
6. **Cross-reference**: Link to function documentation, other vignettes
7. **Keep it focused**: One vignette = one topic

**Vignette Structure Template**:

````markdown
---
title: "Topic Title"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Topic Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

What problem does this vignette solve? Who is it for?

## Setup

```{r}
library(packagename)
data <- make_example_data()
```

## Basic Usage

Start with the simplest possible example.

```{r}
result <- main_function(data)
print(result)
```

## Intermediate Example

Build on the basics.

## Advanced Features

Show power-user features.

## Troubleshooting

Common issues and solutions.

## Further Reading

- Link to related vignettes
- Link to reference documentation
````

---

## Performance and Optimization

### Profiling

**Before optimizing, profile**:

```r
# Profile code
prof <- profvis::profvis({
  result <- slow_function(large_data)
})

# View interactive profile
print(prof)

# Benchmark alternatives
bench::mark(
  approach1 = method1(data),
  approach2 = method2(data),
  iterations = 100,
  check = FALSE  # Don't check if results are identical
)
```

### Optimization Guidelines

1. **Premature optimization is the root of all evil**: Profile first
2. **Vectorize**: Use `apply()`, `vapply()`, `map()` instead of loops
3. **Pre-allocate**: Create output vectors before filling them
4. **Avoid copies**: Modify in place when safe
5. **Use efficient data structures**: data.table > data.frame for large data
6. **Parallel processing**: Use `parallel::mclapply()` for independent iterations
7. **Rcpp for hot paths**: Rewrite inner loops in C++ if needed

**Example Optimization**:

```r
# SLOW - grows vector in loop
result <- numeric(0)
for (i in 1:n) {
  result <- c(result, slow_computation(i))  # Copies entire vector each iteration
}

# FAST - pre-allocate
result <- numeric(n)
for (i in 1:n) {
  result[i] <- slow_computation(i)  # No copying
}

# FASTER - vectorize (if possible)
result <- vapply(1:n, slow_computation, numeric(1))

# FASTEST - parallelize (for expensive computations)
result <- parallel::mclapply(1:n, slow_computation, mc.cores = 4)
result <- unlist(result)
```

---

## Security and Privacy

### Sensitive Data

**NEVER commit**:
- API keys, passwords, tokens
- `.env` files
- Credentials, certificates
- Personal or proprietary data

**Use `.gitignore`**:

```
# Sensitive
.env
.Renviron
credentials.json
*.key
*.pem

# System
.DS_Store
.Rhistory
.RData
.Rproj.user/

# Build
src/*.o
src/*.so
src/*.dll
```

### API Keys in Vignettes/Tests

**Use environment variables**:

```r
# In vignette
#| eval: !expr Sys.getenv("HAVE_API_KEY") != ""

api_key <- Sys.getenv("MY_API_KEY")
if (api_key == "") {
  stop("API key not found. Set MY_API_KEY environment variable.")
}
```

**In tests**:

```r
test_that("API function works", {
  skip_if(Sys.getenv("MY_API_KEY") == "", "API key not available")

  result <- api_function(key = Sys.getenv("MY_API_KEY"))
  expect_type(result, "list")
})
```

### Input Validation

**Never trust user input**:

```r
my_function <- function(file_path, ...) {
  # Validate path
  checkmate::assert_string(file_path)
  checkmate::assert_file_exists(file_path, access = "r")

  # Read safely
  data <- tryCatch(
    readr::read_csv(file_path),
    error = function(e) {
      stop("Failed to read file: ", e$message, call. = FALSE)
    }
  )

  # Validate structure
  checkmate::assert_names(colnames(data), must.include = c("X", "Y", "M"))

  # ...
}
```

---

## Accessibility

### Documentation Accessibility

1. **Use descriptive link text**: "See the [user guide](link)" NOT "Click [here](link)"
2. **Alt text for images**: All plots and diagrams need descriptions
3. **Semantic HTML**: Use proper heading levels in vignettes
4. **Color contrast**: Ensure plots have sufficient contrast

### Plot Accessibility

```r
# Good - colorblind-friendly palette
library(ggplot2)

ggplot(data, aes(x, y, color = group)) +
  geom_point() +
  scale_color_viridis_d() +  # Colorblind-friendly
  theme_minimal() +
  labs(
    title = "Clear, Descriptive Title",
    x = "X-axis label with units",
    y = "Y-axis label with units"
  )
```

---

## CRAN Compliance

### Pre-Submission Checklist

- [ ] `devtools::check()` passes with 0 errors, 0 warnings, 0 notes
- [ ] `rcmdcheck::rcmdcheck(args = "--as-cran")` passes
- [ ] All examples run in <5 seconds each
- [ ] Vignettes run in <5 seconds each (or use Articles)
- [ ] DESCRIPTION has all required fields
- [ ] LICENSE file present
- [ ] NEWS.md updated
- [ ] README.md has installation instructions
- [ ] No `.Rproj` files in submission
- [ ] No `\dontrun{}` without justification (use `\donttest{}`)
- [ ] All URLs in documentation are valid
- [ ] Code coverage â‰¥80%
- [ ] Spell check: `spelling::spell_check_package()`

### Common CRAN Issues

**Issue: Examples/tests too slow**

```r
# Use \donttest{} for slow examples
#' @examples
#' \donttest{
#' # This takes 30 seconds
#' result <- slow_function(big_data)
#' }

# Skip slow tests on CRAN
test_that("slow computation", {
  skip_on_cran()
  # ... slow test ...
})
```

**Issue: External dependencies**

```r
# Check for suggested packages
if (!requireNamespace("lavaan", quietly = TRUE)) {
  stop("Package 'lavaan' required. Install with: install.packages('lavaan')",
       call. = FALSE)
}
```

**Issue: Writing to file system**

```r
# Use tempdir() for all file writes
output_file <- file.path(tempdir(), "output.csv")
write.csv(data, output_file)

# Clean up
on.exit(unlink(output_file), add = TRUE)
```

---

## Communication and Collaboration

### Issue Templates

Create `.github/ISSUE_TEMPLATE/bug_report.md`:

```markdown
---
name: Bug report
about: Report a problem
title: ''
labels: bug
assignees: ''
---

**Describe the bug**
A clear description of the problem.

**To Reproduce**
Steps to reproduce:
1. Load data with ...
2. Run function ...
3. See error

**Expected behavior**
What you expected to happen.

**Reproducible example**

```r
library(packagename)

# Minimal reproducible example
```

**Environment**
- R version:
- Package version:
- OS:

**Additional context**
Any other relevant information.
```

### Ecosystem Communication

**For cross-package issues**:

1. Open issue in foundation package (medfit)
2. Tag maintainers: `@username`
3. Reference in dependent package: "See data-wise/medfit#123"
4. Coordinate via GitHub Discussions for design decisions

**For breaking changes**:

1. Announce in medfit issue with `[BREAKING]` tag
2. Give 2-week notice minimum
3. Update API-CONTRACTS.md
4. Update VERSION-MATRIX.md
5. Coordinate release timeline

---

**Document Status**: Living standard - update as practices evolve
**Review Cycle**: Quarterly or when adding new package to ecosystem
**Feedback**: Open issue in medfit repository
